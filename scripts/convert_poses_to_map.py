#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
convert_poses_to_map.py (Visualization Only Version)

ç”¨é€”ï¼š
    è®€å–ç”± run_localization.py æˆ– server.py ç”¢ç”Ÿçš„è¨ºæ–·å ±å‘Š (CSV)ï¼Œ
    ç›´æ¥ä½¿ç”¨å…¶ä¸­çš„ Map_X, Map_Y, Map_Yaw æ¬„ä½ç¹ªè£½å®šä½çµæœåœ–ã€‚
    ä¸å†é‡è¤‡åŸ·è¡Œ 6DoF è½‰ 2D çš„è¨ˆç®—ã€‚

ç”¨æ³•:
    python scripts/convert_poses_to_map.py diagnosis_report.csv [--anchors anchors.json] [--output result.png]
"""

import argparse
import json
import csv
import matplotlib.pyplot as plt
import numpy as np
from pathlib import Path

def get_data_bounds(data_points, anchors_cfg):
    """è¨ˆç®—ç¹ªåœ–ç¯„åœï¼ŒåŒ…å«å®šä½é»èˆ‡ Anchors"""
    xs = [d['x'] for d in data_points]
    ys = [d['y'] for d in data_points]
    
    # å°‡ Anchors çš„èµ·é»çµ‚é»ä¹Ÿç´å…¥ç¯„åœï¼Œç¢ºä¿èƒŒæ™¯åœ–å®Œæ•´
    for cfg in anchors_cfg.values():
        if 'start_map_xy' in cfg:
            xs.append(cfg['start_map_xy'][0])
            ys.append(cfg['start_map_xy'][1])
        if 'end_map_xy' in cfg:
            xs.append(cfg['end_map_xy'][0])
            ys.append(cfg['end_map_xy'][1])
            
    if not xs: return (0, 1, 0, 1), 1.0
    
    min_x, max_x = min(xs), max(xs)
    min_y, max_y = min(ys), max(ys)
    span_x, span_y = max_x - min_x, max_y - min_y
    return (min_x, max_x, min_y, max_y), max(span_x, span_y)

def plot_results(output_png, data_points, anchors_cfg):
    """ç¹ªè£½çµæœåœ–"""
    (min_x, max_x, min_y, max_y), map_span = get_data_bounds(data_points, anchors_cfg)
    
    # å¢åŠ ä¸€é»é‚Šç•Œç•™ç™½
    pad_x = max((max_x - min_x) * 0.1, 1.0)
    pad_y = max((max_y - min_y) * 0.1, 1.0)
    plot_xlim = (min_x - pad_x, max_x + pad_x)
    plot_ylim = (min_y - pad_y, max_y + pad_y)

    # å‹•æ…‹è¨ˆç®—åœ–ç‰‡å°ºå¯¸
    final_w = plot_xlim[1] - plot_xlim[0]
    final_h = plot_ylim[1] - plot_ylim[0]
    aspect = final_w / final_h if final_h > 0 else 1.0
    
    fig_h = 10
    fig_w = fig_h * aspect
    if fig_w > 20: fig_w = 20 # é™åˆ¶æœ€å¤§å¯¬åº¦ä»¥å…å¤ªå¯¬
    
    plt.figure(figsize=(fig_w, fig_h))
    plt.title(f"Localization Map Result (N={len(data_points)})")
    plt.xlabel("Map X")
    plt.ylabel("Map Y")
    plt.grid(True, linestyle='--', alpha=0.6)

    # 1. ç¹ªè£½å®šä½é»
    # æ ¹æ“š Block åˆ†é¡é¡è‰²
    unique_blocks = sorted(list(set(d['block'] for d in data_points)))
    cmap = plt.get_cmap("tab10")
    block_colors = {b: cmap(i % 10) for i, b in enumerate(unique_blocks)}

    arrow_len = map_span * 0.02 if map_span > 0 else 1.0
    
    for d in data_points:
        color = block_colors.get(d['block'], 'black')
        plt.scatter(d['x'], d['y'], color=color, s=30, alpha=0.8, edgecolors='k', linewidth=0.3)
        
        # ç¹ªè£½æ–¹å‘ç®­é ­ (Yaw)
        if d['yaw'] is not None:
            # Map_Yaw é€šå¸¸æ˜¯ Degreeï¼Œéœ€è½‰ Radian
            dx = arrow_len * np.cos(np.radians(d['yaw']))
            dy = arrow_len * np.sin(np.radians(d['yaw']))
            plt.arrow(d['x'], d['y'], dx, dy, head_width=arrow_len*0.3, color=color, alpha=0.8)
        
        # (é¸ç”¨) æ¨™è¨»æª”åï¼Œè‹¥é»å¤ªå¤šå»ºè­°è¨»è§£æ‰
        # plt.text(d['x'], d['y'], d['name'], fontsize=6, alpha=0.5)

    # 2. ç¹ªè£½ Anchors (åƒè€ƒç·š)
    added_label = False
    for block_name, cfg in anchors_cfg.items():
        if 'start_map_xy' not in cfg or 'end_map_xy' not in cfg: continue
        
        sx, sy = cfg['start_map_xy']
        ex, ey = cfg['end_map_xy']
        
        label = "Anchors" if not added_label else None
        plt.plot([sx, ex], [sy, ey], 'r--', linewidth=1.5, alpha=0.4, label=label, zorder=0)
        plt.scatter([sx, ex], [sy, ey], marker='x', color='red', s=60, zorder=0)
        
        # æ¨™è¨» Anchor åç¨±
        plt.text(sx, sy, f" {block_name}_Start", color='red', fontsize=8, alpha=0.6)
        added_label = True

    # å»ºç«‹ Legend
    from matplotlib.lines import Line2D
    legend_elements = [Line2D([0], [0], marker='o', color='w', label=b, 
                          markerfacecolor=c, markersize=8) for b, c in block_colors.items()]
    if added_label:
        legend_elements.append(Line2D([0], [0], color='r', linestyle='--', label='Anchors'))
        
    plt.legend(handles=legend_elements, loc='best')
    plt.xlim(plot_xlim)
    plt.ylim(plot_ylim)
    plt.tight_layout()
    plt.savefig(output_png, dpi=150)
    plt.close()
    print(f"ğŸ–¼ï¸  [Output] Plot saved to: {output_png}")

def main():
    parser = argparse.ArgumentParser(description="Visualize localization results from diagnosis report (CSV).")
    parser.add_argument("report_csv", type=Path, help="Path to diagnosis_report.csv (generated by run_localization.py)")
    parser.add_argument("--anchors", type=Path, default="anchors.json", help="Path to anchors.json (for visualization context)")
    parser.add_argument("--output", type=Path, default=None, help="Output PNG path (default: same as csv name)")
    
    args = parser.parse_args()

    if not args.report_csv.exists():
        print(f"[Error] Report file not found: {args.report_csv}")
        return

    # 1. è®€å– Anchors (åƒ…ç”¨æ–¼ç¹ªåœ–åƒè€ƒï¼Œä¸éœ€è¦å®ƒä¾†è¨ˆç®—è½‰æ›)
    anchors_cfg = {}
    if args.anchors.exists():
        try:
            with open(args.anchors, 'r') as f:
                anchors_cfg = json.load(f)
        except Exception as e:
            print(f"[Warn] Failed to load anchors: {e}")
    else:
        print(f"[Warn] Anchors file not found: {args.anchors}. Plotting without reference anchors.")

    # 2. è®€å– CSV
    data_points = []
    print(f"[Info] Reading report: {args.report_csv}")
    
    with open(args.report_csv, 'r', encoding='utf-8-sig') as f:
        reader = csv.DictReader(f)
        
        # æª¢æŸ¥å¿…è¦æ¬„ä½æ˜¯å¦å­˜åœ¨
        if 'Map_X' not in reader.fieldnames:
            print("[Error] CSV format error: Column 'Map_X' not found.")
            print("Please ensure your localization_engine.py is updated and calculating map coordinates.")
            return

        for row in reader:
            # è·³éæœªå®šä½æˆåŠŸçš„é» (Map_X ç‚ºç©º)
            if not row.get('Map_X') or row['Map_X'].strip() == "":
                continue
                
            try:
                x = float(row['Map_X'])
                y = float(row['Map_Y'])
                # è‹¥ Map_Yaw ç‚ºç©ºå‰‡é è¨­ 0
                yaw = float(row['Map_Yaw']) if row.get('Map_Yaw') else 0.0
                
                # å–å¾— Block åç¨± (å„ªå…ˆä½¿ç”¨ PnP_Top1_Block)
                block = row.get('PnP_Top1_Block', 'Unknown')
                if block == 'None': block = 'Unknown'
                
                name = row.get('ImageName', 'Unknown')
                
                data_points.append({
                    'name': name,
                    'x': x,
                    'y': y,
                    'yaw': yaw,
                    'block': block
                })
            except ValueError:
                continue

    print(f"[Info] Loaded {len(data_points)} localized points.")

    if not data_points:
        print("[Warn] No valid points found in report (Maybe all failed?).")
        return

    # 3. ç¹ªåœ–
    out_path = args.output
    if out_path is None:
        out_path = args.report_csv.with_suffix('.png')
    
    plot_results(out_path, data_points, anchors_cfg)

if __name__ == "__main__":
    main()